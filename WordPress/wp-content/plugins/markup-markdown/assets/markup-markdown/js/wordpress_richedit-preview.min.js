/**
 * @preserve The Markup Markdown Preview Module
 * @desc Everything needed to handle the preview. Mostly cache and media rules handlers
 * @author Pierre-Henri Lavigne <lavigne.pierrehenri@proton.me>
 * @version 1.1.3
 * @license GPL 3 - https://www.gnu.org/licenses/gpl-3.0.html#license-text
 */
(u=>{var g={};function n(t){var n=this,r=(n.isReady=0,u(window).on("resize.mmd_preview",function(t){n.clipbox(t)}),u("#mmd_preview-css").length||u("head").append('<style type="text/css" id="mmd_preview-css"></style>'),n.previewSheet=document.getElementById("mmd_preview-css")||!1,t.base_url&&t.callbacks&&(n.base_url=t.base_url,n.callbacks=t.callbacks,n.isReady=1),[]),s={gallery:"renderGallery",videoPlaylist:"renderVideoPlaylist",audioPlaylist:"renderAudioPlaylist",convertImage:"convertHTMLImage",convertAudio:"convertAudioShortcode",convertVideo:"convertVideoShortcode",convertHeading:"convertHeadingTags",convertLatexFormulas:"renderLatexSnippets"};return{flushQueue:function(){r=[]},add2Queue:function(t,e,i){var a=n.hashString(e||"");return g&&g[a]?g[a].join(""):t&&s[t]?(r.push([s[t],e||"",i||0]),""):void 0},runQueue:function(){for(var t,e=0;e<r.length;e++)t=r[e],n[t[0]](t[1],t[2])},processTask:function(t,e,i){return t&&s[t]?n[s[t]](e||"",i||0):""}}}n.prototype.hashString=function(t){for(var e=0,i=t.length;i--;)e=(e=(e+=t.charCodeAt(i))+(e<<10))^e>>6;return"t"+(e=(e=(e+=e<<3)^e>>11)+(e<<15))},n.prototype.clipbox=function(t){var e=[];u(".tmp_media").each(function(){e.push('div[data-pointer="'+u(this).attr("data-pointer")+'"]{min-height:'+Math.ceil(u(this).height())+"px}")}),e.push(".tmp_span_block{display:block}"),e.push(".tmp_span_inline{display:inline-block;vertical-align:baseline}"),this.previewSheet.innerText=e.join("")},n.prototype.extractExtra=function(t){if(!t||!t.length)return!1;var e=t.match(/([^\s][\#\.]*[a-zA-Z0-9-_=]+[^\W]*)/g);if(!e||!e.length)return!1;for(var i,a={},n=0;n<e.length;n++)i=e[n],/^#/.test(i)?(a.id=a.id||"",a.id+=i.replace("#","")):/^\./.test(i)?(a.class=a.class||"",a.class+=" "+i.replace(".","")):/\=/.test(i)&&(a[(i=i.split("="))[0]]=i[1]);var r,s=[];for(r in a)s.push(r+'="'+a[r].replace(/^\s*|\s*$/,"")+'"');return" "+s.join(" ")},n.prototype.convertHeadingTags=function(t){var e,i=this.hashString(t);return g&&g[i]?g[i].join(""):(e=t.match(/<h(\d)[^\>]*>(.*?)\{([^\}]+)\}<\/h\d>/))&&e.length&&4===e.length?(e=["<h"+e[1],this.extractExtra(e[3])||"",">",e[2],"</h"+e[1]+">"],(g[i]=e).join("")):(g[i]=[t],t)},n.prototype.renderGallery=function(n,r){var i=this,a=i.hashString(n),t=(n||"").match(/ids\=\"(.*?)\"/);if(t&&t[1]){for(var e,s={size:"thumbnail",columns:3,link:"none"},l=function(t){for(var e=[],i=(e.push(['<div id="gallery-'+r+'"',' class="gallery galleryid-'+r," gallery-columns-"+s.columns," gallery-size-"+s.size,'" data-shortcode="'+encodeURIComponent(n)+'">'].join("")),[]),a=0;a<t.length;a++)i.push(o(wp.media.attachment(t[a]).attributes));return i.length?((e=e.concat(i)).push("</div>"),e):""},o=function(t){var e;return t&&t.sizes?((e=['<figure class="gallery-item">']).push('<div class="gallery-icon '+(t.width>t.height?"landscape":"portrait")+'">'),"none"!==s.link&&e.push('<a href="'+("file"===s.link?t.url:t.link)+'" target="_blank">'),e.push(['<img src="'+(t.sizes[s.size]||t.sizes.thumbnail).url+'"',' alt="'+(t.alt||t.title)+'"',' width="'+(t.sizes[s.size].width||t.width)+'"',' height="'+(t.sizes[s.size].height||t.height)+'"',t.caption?' aria-describedby="gallery-'+r+"-"+t.id+'"':"",'">'].join("")),"none"!==s.link&&e.push("</a>"),e.push("</div>"),t.caption&&e.push(['<figcaption class="wp-caption-text gallery-caption" id="gallery-'+r+"-"+t.id+'">',t.caption,"</figcaption>"].join("")),e.push("</figure>"),e.join("")):""},h=(/columns/.test(n)&&(e=n.match(/columns\=\"(.*?)\"/)||[])&&e[1]&&!isNaN(+e[1])&&(s.columns=+e[1]),/size/.test(n)&&(e=n.match(/size\=\"(.*?)\"/)||[])&&e[1]&&new RegExp(e[1].toLowerCase()).test("small medium large full")&&(s.size=e[1].toLowerCase()),/link/.test(n)&&(e=n.match(/link\=\"(.*?)\"/)||[])&&e[1]&&new RegExp(e[1].toLowerCase()).test("post file none")&&(s.link=e[1].toLowerCase()),t[1].split(",")),c=h.length,p=0;p<h.length;p++)h[p]=+h[p],wp.media.attachment(h[p])&&wp.media.attachment(h[p]).attributes&&wp.media.attachment(h[p]).attributes.sizes||c--;var d=function(){var t,e=u('div[data-pointer="tmp_gallery-'+r+'"]')[0]||!1;return!!e&&!(!(t=l(h))||!t.length)&&(g[a]||(g[a]=t),e.innerHTML=t.join(""),void(i.callbacks&&i.callbacks.widget&&"function"==typeof i.callbacks.widget&&i.callbacks.widget()))};c!==h.length?wp.media.query({post__in:h}).more().then(function(){setTimeout(function(){d(),u(window).trigger("resize.mmd_preview")},250)}):setTimeout(function(){d(),u(window).trigger("resize.mmd_preview")},250)}return""},n.prototype.convertHTMLImage=function(t,e){var i=t.match(/<img(.*?)>\{([^\}]+)\}/),a=this.hashString(t);if(g&&g[a])return g[a].join("");if(!i||i.length<2)return t.replace(/\{[^\}]+\}/,"");var n=t.match(/<img(.*?)>\{([^\}]+)\}/g);if(n&&n.length){for(var r,s=0,l=[],o="",h=[],c="";s<n.length;s++){var p,d=(d=t.match('<a href="(.*?)"[^>]*>'+i[s]))&&0<d.length?d[1]:"",l=n[s].match(/<img(.*?)>\{(.*?)\}/),o="<figure"+(this.extractExtra(n[2])||"")+">";d&&d.length&&(o+='<a href="'+d+'" target="_blank">'),o+="<img"+l[1]+">",h=l[1].match(/alt\=\"(.*?)\"/),r=l[1].match(/src\=\"(.*?)-(\d+)x(\d+)\.(\w+)\"/),c="",h&&h[1]&&/--/.test(h[1])&&(h=(p=h[1].split("--"))[0].replace(/^\s*|\s*$/,""),c=p[1].replace(/^\s*|\s*$/,"")),d&&d.length&&(o+="</a>"),c&&c.length&&(o=(o=o.replace(/class="(.*?)"/,'class="wp-block-image wp-caption $1"')).replace(/alt=".*?"/,'alt="'+h+'"'),o+='<figcaption class="wp-caption-text wp-element-caption">'+c+"</figcaption>"),r&&r[2]&&!isNaN(+r[2])&&(o=o.replace(/<figure/,'<figure style="width:'+r[2]+'px"')),o+="</figure>",t=d&&d.length?t.replace(new RegExp("<a\\s[^>]*>"+n[s]+"</a>","g"),o):t.replace(n[s],o)}g[a]=[t]}return t},n.prototype.convertAudioShortcode=function(t,e){var i=this.hashString(t=t||"");return g&&g[i]?g[i].join(""):(t=t.match(/^\[audio.*?src\=\"(.*?)\".*?\]\[\/audio\]$/)||!1)&&t.length&&0<t.length?(e='<audio class="wp-audio-shortcode" id="audio-'+e+'" preload="none" ',e+='style="width: 100%;" controls="controls" src="'+t[1]+'"></audio>',g[i]=[e],e):""},n.prototype.convertVideoShortcode=function(t,e){var i,a,n,r,s=this.hashString(t=t||"");return g&&g[s]?g[s].join(""):(i=t.match(/src\=\"(.*?)\"/)||!1,a=t.match(/width\=\"(.*?)\"/)||!1,t=t.match(/height\=\"(.*?)\"/)||!1,n="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' version='1.1' ",r="%3Crect ",i&&i.length&&0<i.length?(e='<video class="wp-video-shortcode" id="video-'+e+'" preload="none" ',e+='style="width: 100%; height: auto;" controls="controls" ',a&&a.length&&0<a.length&&(e+='width="'+a[1]+'" ',n+="width='"+a[1]+"' ",r+="width='"+a[1]+"' "),t&&t.length&&0<t.length&&(e+='height="'+t[1]+'" ',n+="height='"+t[1]+"' ",r+="height='"+t[1]+"' "),e=e+('poster="'+(n+="%3E"+(r+=" fill='%23EDEDED'%3E%3C/rect%3E")+"%3C/svg%3E"))+'" src="'+i[1]+'"></video>',g[s]=[e],e):"")},n.prototype.renderVideoPlaylist=function(s,l){var i=this,t=(s||"").match(/ids\=\"(.*?)\"/);if(!t||!t[1])return"";var a=i.hashString(s);if(g&&g[a])return g[a].join("");for(var e,n=function(t){for(var e,i=[],a=0;a<t.length;a++)(e=wp.media.attachment(+t[a]).attributes).url&&(e={src:e.url,type:e.mime,title:e.title,caption:e.caption,description:e.description,meta:e.meta,dimensions:{original:{width:e.width,height:e.height},resized:{width:640,height:Math.ceil(640*e.height/e.width)}},image:{src:e.image.src,width:e.image.width,height:e.image.height},thumb:{src:e.thumb.src,width:e.thumb.width,height:e.thumb.height}},i.push(e));if(!i.length)return"";var n=['<div id="playlist-'+l+'" class="wp-playlist wp-video-playlist wp-playlist-light" data-shortcode="'+encodeURIComponent(s)+'">'];n.push('<video controls="controls" preload="none" width="'+i[0].dimensions.resized.width+'" height="'+i[0].dimensions.resized.height+'"></video>'),n.push('<div class="wp-playlist-next"></div>'),n.push('<div class="wp-playlist-prev"></div>'),n.push('<script type="application/json" class="wp-playlist-script">'),n.push('{"type":"video","tracklist":true,"tracknumbers":true,"images":true,"artists":true,"tracks":[');for(var r=0;r<i.length;r++)n.push((0<r?",":"")+JSON.stringify(i[r]));return n.push("]}<\/script>"),n.push("</div>"),n},r=function(){var t,e=u('div[data-pointer="tmp_video_playlist-'+l+'"]')[0]||!1;return!!e&&!(!(t=n(o))||!t.length)&&(e.innerHTML=t.join(""),window.wp&&window.wp.playlist&&"function"==typeof window.wp.playlist.initialize&&setTimeout(function(){window.wp.playlist.initialize(),setTimeout(function(){g[a]||(g[a]=[e.innerHTML])},250)},250),void(i.callbacks&&i.callbacks.widget&&"function"==typeof i.callbacks.widget&&i.callbacks.widget()))},o=t[1].split(","),h=o.length,c=0;c<o.length;c++)o[c]=+o[c],(e=wp.media.attachment(o[c]).attributes||!1)&&e.url&&(!e.url||e.url.length)||h--;return h<o.length?wp.media.query({post__in:o}).more().then(function(t){setTimeout(r,250)}):setTimeout(r,250),!0},n.prototype.renderAudioPlaylist=function(s,l){var i=this,t=(s||"").match(/ids\=\"(.*?)\"/);if(!t||!t[1])return"";var a=i.hashString(s);if(g&&g[a])return g[a].join("");for(var e,n=function(t){for(var e,i=[],a=0;a<t.length;a++)(e=wp.media.attachment(+t[a]).attributes).url&&(e={src:e.url,type:e.mime,title:e.title,caption:e.caption,description:e.description,meta:e.meta,image:{src:e.image.src,width:e.image.width,height:e.image.height},thumb:{src:e.thumb.src,width:e.thumb.width,height:e.thumb.height}},i.push(e));if(!i.length)return"";var n=['<div id="playlist-'+l+'" class="wp-playlist wp-audio-playlist wp-playlist-light" data-shortcode="'+encodeURIComponent(s)+'">'];n.push('<audio controls="controls" preload="none" width="582"></audio>'),n.push('<div class="wp-playlist-next"></div>'),n.push('<div class="wp-playlist-prev"></div>'),n.push('<script type="application/json" class="wp-playlist-script">'),n.push('{"type":"audio","tracklist":true,"tracknumbers":true,"images":true,"artists":true,"tracks":[');for(var r=0;r<i.length;r++)n.push((0<r?",":"")+JSON.stringify(i[r]));return n.push("]}<\/script>"),n.push("</div>"),n},r=function(){var t,e=u('div[data-pointer="tmp_audio_playlist-'+l+'"]')[0]||!1;return!!e&&!(!(t=n(o))||!t.length)&&(e.innerHTML=t.join(""),window.wp&&window.wp.playlist&&"function"==typeof window.wp.playlist.initialize&&setTimeout(function(){window.wp.playlist.initialize(),setTimeout(function(){g[a]||(g[a]=[e.innerHTML])},250)},250),void(i.callbacks&&i.callbacks.widget&&"function"==typeof i.callbacks.widget&&i.callbacks.widget()))},o=t[1].split(","),h=o.length,c=0;c<o.length;c++)o[c]=+o[c],(e=wp.media.attachment(o[c]).attributes||!1)&&e.url&&(!e.url||e.url.length)||h--;return h<o.length?wp.media.query({post__in:o}).more().then(function(t){setTimeout(r,250)}):setTimeout(r,250),!0},n.prototype.renderLatexSnippets=function(t,e){var i=this.hashString(t);if(g&&g[i])return g[i].join("");var a=t.match(/\${1,2}([^\$]+)\${1,2}/);if(!a||!a[1])return!1;var n=a[1].replace(/<br\s*\/*>/g,"\n").replace(/(^\n|\n$)/,""),r=u('span[data-pointer="tmp_latex-'+e+'"]')[0]||!1;if(!r)return!1;if(r.parentNode)for(var s,l=0;l<3;){if("CODE"===((s=r.parentNode||{}).tagName||"").toUpperCase()||/hljs/.test(s.className||""))return r.parentNode.removeChild(r),!1;l++}return r&&!/tmp_ui_ready/.test(r.className)&&(r.className+=" tmp_ui_ready",setTimeout(function(){if(!r)return!1;var t=!!/\$\$/.test(a);window.katex?katex.render(n,r,{displayMode:t,throwOnError:!1}):window.MathJax&&(MathJax.tex2chtml&&"function"==typeof MathJax.tex2chtml?r.appendChild(MathJax.tex2chtml(n),{em:16,ex:8,display:t}):MathJax.tex2svg&&"function"==typeof MathJax.tex2svg&&r.appendChild(MathJax.tex2svg(n),{em:16,ex:8,display:t})),g[i]||(g[i]=[r.innerHTML])},250)),!0},window.MmdPreview=function(t){var e=(t=t||{}).callbacks||{},t=t.base_url||"",i=function(){},a=function(){};return e.widget&&"function"==typeof e.widget||(e.widget=i),e.multisel&&"function"==typeof e.multisel||(e.multisel=a),new n({base_url:t,callbacks:e})}})(window.jQuery);